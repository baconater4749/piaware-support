#!/bin/sh -e

# rpi-bootconfig-kernel: kernel postinst hook that updates /boot/config.txt
# when a new kernel is installed

# called as: rpi-bootconfig-kernel [-d] <kernel-version> [<path-to-kernel>]

BOOTCONFIG=/boot/config.txt

if [ "$1" = "-d" ]
then
    shift
    mode=remove
else
    mode=install
fi

if [ $# -lt 1 ]
then
    echo "$0: insufficient arguments" >&2
    exit 1
fi

case "$1" in
    *-v7+)
        vx=v7
        types="pi2 pi3"
        kernelimg="kernel7.img"
        ;;
    *+)
        vx=v6
        types="pi0 pi1"
        kernelimg="kernel.img"
        ;;
    *)
        echo "$0: unrecognized kernel version, not updating $BOOTCONFIG" >&2
        exit 0
        ;;
esac

if [ -n "$2" ]
then
    kernelimg=$(basename $2)
fi

echo -n "Updating $BOOTCONFIG for kernel version $1 .. " >&2

rm -f $BOOTCONFIG.new
(
    sed -e "/^## start of rpi-bootconfig kernel section for $vx kernels/,/^## end of rpi-bootconfig kernel section for $vx kernels/ d" <$BOOTCONFIG

    if [ "$mode" = "install" ]
    then
        echo "## start of rpi-bootconfig kernel section for $vx kernels. Do not modify or remove this line."
        for type in $types
        do
            echo "[$type]"
            echo "kernel=$kernelimg"
        done
        echo "## end of rpi-bootconfig kernel section for $vx kernels. Do not modify or remove this line."
    fi
) >$BOOTCONFIG.new

sync
mv $BOOTCONFIG.new $BOOTCONFIG
sync

echo "done." >&2
exit 0
